# ============================================================
# Gemini API ì—°ë™ ëª¨ë“ˆ
# ============================================================
# Google Gemini APIë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒí’ˆ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ
# ì¹´í…Œê³ ë¦¬ë³„ ë‹¤ë¥¸ êµ¬ì¡°ë¡œ ê²Œì‹œê¸€ ìƒì„±
# - ê±´ê°•ì‹í’ˆ / ìƒí™œìš©í’ˆ / ê°€ì „ì œí’ˆ / ìœ ì•„ì¶œì‚° / ê¸°íƒ€
# ============================================================

import random
import re
import requests
import json

from config import GEMINI_API_KEY

GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent"

CATEGORIES = ["ê±´ê°•ì‹í’ˆ", "ìƒí™œìš©í’ˆ", "ê°€ì „ì œí’ˆ", "ìœ ì•„/ì¶œì‚°", "ê¸°íƒ€"]


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# length_mode: short / medium
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
LENGTH_MODES = ["short", "medium"]

# short: 3~4ë¬¸ë‹¨, í•µì‹¬ 2ê°€ì§€, ê°€ê²© ê°€ë³ê²Œ, 800~1200ì
# medium: 5~7ë¬¸ë‹¨, íŠ¹ì§•+ì¥ì  3ê°€ì§€, ì¶”ì²œëŒ€ìƒ, ê°€ê²©, 1500~2200ì
LENGTH_MODE_RULES = {
    "short": """
[ë¶„ëŸ‰ ëª¨ë“œ: short - ì§§ê³  í•µì‹¬ ìœ„ì£¼]
- ë„ì…ë¶€: 150~200ì (ì§§ê²Œ)
- ì „ì²´ ë¬¸ë‹¨ ìˆ˜: 3~4ê°œ
- í•µì‹¬ íŠ¹ì§• 2ê°€ì§€ ì •ë„ë§Œ
- ê°€ê²©ì€ ê°€ë³ê²Œ ì–¸ê¸‰
- ì´ ë¶„ëŸ‰: 800~1200ì
- ì´ë¯¸ì§€ 1ì¥ ê¸°ì¤€ìœ¼ë¡œ ì–´ìƒ‰í•˜ì§€ ì•Šê²Œ êµ¬ì„±
- shortì™€ mediumì€ ë¬¸ë‹¨ ìˆ˜Â·ë¬¸ì¥ ìˆ˜Â·ì •ë³´ ê¹Šì´ê°€ í™•ì‹¤íˆ ë‹¤ë¥´ê²Œ ëŠê»´ì§€ë„ë¡
""",
    "medium": """
[ë¶„ëŸ‰ ëª¨ë“œ: medium - ì¶©ì‹¤í•œ ì •ë³´í˜•]
- ë„ì…ë¶€: 250~350ì (ì¶©ì‹¤í•˜ê²Œ)
- ì „ì²´ ë¬¸ë‹¨ ìˆ˜: 5~7ê°œ
- íŠ¹ì§• + ì¥ì  3ê°€ì§€
- ì¶”ì²œ ëŒ€ìƒ í¬í•¨
- ê°€ê²© ì–¸ê¸‰
- ì´ ë¶„ëŸ‰: 1500~2200ì
- ì´ë¯¸ì§€ 1ì¥ ê¸°ì¤€ ìì—°ìŠ¤ëŸ¬ìš´ ë¶„ëŸ‰
- shortì™€ mediumì€ ë¬¸ë‹¨ ìˆ˜Â·ë¬¸ì¥ ìˆ˜Â·ì •ë³´ ê¹Šì´ê°€ í™•ì‹¤íˆ ë‹¤ë¥´ê²Œ ëŠê»´ì§€ë„ë¡
""",
}


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì¹´í…Œê³ ë¦¬ë³„ í”„ë¡¬í”„íŠ¸ ìƒì„±
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def _get_category_prompt(category, keyword, items_text, length_mode="medium"):
    """ì¹´í…Œê³ ë¦¬ë³„ + length_modeë³„ Gemini í”„ë¡¬í”„íŠ¸ ë°˜í™˜"""
    length_rules = LENGTH_MODE_RULES.get(length_mode, LENGTH_MODE_RULES["medium"])

    base_rules = """
- ìƒì—…ì  ë¬¸êµ¬ ê³¼ë„ ì‚¬ìš© ê¸ˆì§€, êµ¬ë§¤ ê°•ìš” ê¸ˆì§€.
- ìì—°ìŠ¤ëŸ¬ìš´ ì •ë³´í˜• ë¬¸ì²´ (~í•´ìš”, ~ì´ë”ë¼ê³ ìš”).
- ì ˆëŒ€ * ë¬¸ì(ë³„í‘œ)ë¥¼ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”. ë§ˆí¬ë‹¤ìš´ ì„œì‹ ê¸ˆì§€.
- [íŒŒíŠ¸ A], [íŒŒíŠ¸ B], ## íŒŒíŠ¸ A, ## íŒŒíŠ¸ B, ìƒí’ˆë³„ ìš”ì•½, ê±´ê°•ì‹í’ˆ í˜•ì‹, ê³µê°í˜• ë„ì… ë“± ì‘ì„± ì§€ì¹¨/êµ¬ì¡° í‘œì‹œë¥¼ ë³¸ë¬¸ì— ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”. ì´ëŠ” êµ¬ì¡° ì•ˆë‚´ì¼ ë¿ ì¶œë ¥í•˜ë©´ ì•ˆ ë©ë‹ˆë‹¤.
- ë¬¸ë‹¨ ì‚¬ì´ ì¤„ë°”ê¿ˆì€ 1~3ì¤„ ëœë¤ ì ìš©.
- ê°€ë…ì„±: ì£¼ìš” ë‹¨ë½Â·ì†Œì œëª© ì•ì— ë°˜ë“œì‹œ âœ… ì´ëª¨í‹°ì½˜ì„ ë¶™ì´ì„¸ìš”. ì˜ˆ) âœ… ì˜¤ëŠ˜ì˜ ì¶”ì²œ ìƒí’ˆ: {ìƒí’ˆëª…}
- ê°€ê²©Â·í˜œíƒ: ê°€ê²©(ì˜ˆ: 12,000ì›), ë¡œì¼“ë°°ì†¡, ë¬´ë£Œë°°ì†¡ ë“± í•µì‹¬ ì •ë³´ëŠ” ë¬¸ì¥ ë‚´ì—ì„œ êµ¬ë¶„ë˜ê²Œ ì‘ì„±.
- ìƒ‰ìƒ ë‚¨ìš© ê¸ˆì§€: ì†Œì œëª©ê³¼ í•µì‹¬ ê°€ê²©/í˜œíƒì—ë§Œ ê°•ì¡°ë¥¼ ë‘ì„¸ìš”.
"""
    base_rules += length_rules

    prompts = {
        "ê±´ê°•ì‹í’ˆ": f"""ë‹¹ì‹ ì€ ë„¤ì´ë²„ ì¹´í˜ ë¸”ë¡œê·¸ ì „ë¬¸ ë¦¬ë·°ì–´ì…ë‹ˆë‹¤.
ë°œí–‰ ì¹´í…Œê³ ë¦¬: ê±´ê°•ì‹í’ˆ
ê²€ìƒ‰ í‚¤ì›Œë“œ "{keyword}"ì— ëŒ€í•´ ì‘ì„±í•´ì£¼ì„¸ìš”.
{base_rules}

[íŒŒíŠ¸ A: ê³µê°í˜• ë„ì…]
- "{keyword}"ë¥¼ ê²€ìƒ‰í•˜ëŠ” ë¶„ë“¤ì´ ê³µê°í•  ë§Œí•œ ê³ ë¯¼Â·ìƒí™©ì„ ë¬˜ì‚¬í•˜ì„¸ìš”.
- ë¸”ë¡œê·¸ ë§íˆ¬ë¡œ ì¹œê·¼í•˜ê²Œ ì‘ì„±í•˜ì„¸ìš”.
---ë„ì…ë¶€---
(ë„ì…ë¶€ ë¬¸êµ¬)

[íŒŒíŠ¸ B: ìƒí’ˆë³„ ìš”ì•½ - ê±´ê°•ì‹í’ˆ í˜•ì‹]
ê° ìƒí’ˆë§ˆë‹¤: ì„±ë¶„/íŠ¹ì§•, ì¶”ì²œëŒ€ìƒ, ê°€ê²© ì–¸ê¸‰. length_modeì— ë§ê²Œ ë¶„ëŸ‰ ì¡°ì ˆ.
---ìƒí’ˆ1---
(ìš”ì•½)
---ìƒí’ˆ2---
(ìš”ì•½)
...

[ìƒí’ˆ ëª©ë¡]
{items_text}
""",
        "ìƒí™œìš©í’ˆ": f"""ë‹¹ì‹ ì€ ë„¤ì´ë²„ ì¹´í˜ ë¸”ë¡œê·¸ ì „ë¬¸ ë¦¬ë·°ì–´ì…ë‹ˆë‹¤.
ë°œí–‰ ì¹´í…Œê³ ë¦¬: ìƒí™œìš©í’ˆ
ê²€ìƒ‰ í‚¤ì›Œë“œ "{keyword}"ì— ëŒ€í•´ ì‘ì„±í•´ì£¼ì„¸ìš”.
{base_rules}

[íŒŒíŠ¸ A: ë¶ˆí¸í–ˆë˜ ìƒí™© ì œì‹œ]
- ì‚¬ìš© ì „ ë¶ˆí¸í–ˆë˜ ìƒí™©ì„ ê³µê°ì ìœ¼ë¡œ ë¬˜ì‚¬í•˜ì„¸ìš”.
---ë„ì…ë¶€---
(ë„ì…ë¶€ ë¬¸êµ¬)

[íŒŒíŠ¸ B: ìƒí’ˆë³„ ìš”ì•½ - ìƒí™œìš©í’ˆ í˜•ì‹]
ê° ìƒí’ˆë§ˆë‹¤: ë°œê²¬ê³„ê¸°, ì‚¬ìš©ê°, ì¥ì , ê°€ê²©. length_modeì— ë§ê²Œ ë¶„ëŸ‰ ì¡°ì ˆ.
---ìƒí’ˆ1---
(ìš”ì•½)
---ìƒí’ˆ2---
(ìš”ì•½)
...

[ìƒí’ˆ ëª©ë¡]
{items_text}
""",
        "ê°€ì „ì œí’ˆ": f"""ë‹¹ì‹ ì€ ë„¤ì´ë²„ ì¹´í˜ ë¸”ë¡œê·¸ ì „ë¬¸ ë¦¬ë·°ì–´ì…ë‹ˆë‹¤.
ë°œí–‰ ì¹´í…Œê³ ë¦¬: ê°€ì „ì œí’ˆ
ê²€ìƒ‰ í‚¤ì›Œë“œ "{keyword}"ì— ëŒ€í•´ ì‘ì„±í•´ì£¼ì„¸ìš”.
{base_rules}

[íŒŒíŠ¸ A: ê¸°ì¡´ ì œí’ˆê³¼ ë¹„êµ ë„ì…]
- ê¸°ì¡´ ì œí’ˆì˜ ë¶ˆí¸í•¨ ë˜ëŠ” ìƒˆ ì œí’ˆì„ ì°¾ê²Œ ëœ ê³„ê¸°ë¥¼ ë¬˜ì‚¬í•˜ì„¸ìš”.
---ë„ì…ë¶€---
(ë„ì…ë¶€ ë¬¸êµ¬)

[íŒŒíŠ¸ B: ìƒí’ˆë³„ ìš”ì•½ - ê°€ì „ì œí’ˆ í˜•ì‹]
ê° ìƒí’ˆë§ˆë‹¤: ìŠ¤í™, ì¥ë‹¨ì , ì¶”ì²œëŒ€ìƒ, ê°€ê²©ëŒ€. length_modeì— ë§ê²Œ ë¶„ëŸ‰ ì¡°ì ˆ.
---ìƒí’ˆ1---
(ìš”ì•½)
---ìƒí’ˆ2---
(ìš”ì•½)
...

[ìƒí’ˆ ëª©ë¡]
{items_text}
""",
        "ìœ ì•„/ì¶œì‚°": f"""ë‹¹ì‹ ì€ ë„¤ì´ë²„ ì¹´í˜ ë¸”ë¡œê·¸ ì „ë¬¸ ë¦¬ë·°ì–´ì…ë‹ˆë‹¤.
ë°œí–‰ ì¹´í…Œê³ ë¦¬: ìœ ì•„/ì¶œì‚°
ê²€ìƒ‰ í‚¤ì›Œë“œ "{keyword}"ì— ëŒ€í•´ ì‘ì„±í•´ì£¼ì„¸ìš”.
{base_rules}

[íŒŒíŠ¸ A: ì•ˆì „ì„± ê°•ì¡° ë„ì…]
- ì•„ì´ì—ê²Œ ì“°ëŠ” ì œí’ˆì— ëŒ€í•œ ë¶€ëª¨ë‹˜ë“¤ì˜ ê±±ì •ì„ ê³µê°í•˜ì„¸ìš”.
---ë„ì…ë¶€---
(ë„ì…ë¶€ ë¬¸êµ¬)

[íŒŒíŠ¸ B: ìƒí’ˆë³„ ìš”ì•½ - ìœ ì•„/ì¶œì‚° í˜•ì‹]
ê° ìƒí’ˆë§ˆë‹¤: ì†Œì¬/ì„±ë¶„, ë¶€ëª¨ í›„ê¸° ëŠë‚Œ. ì¡°ì‹¬ìŠ¤ëŸ¬ìš´ ë§ˆë¬´ë¦¬. length_modeì— ë§ê²Œ ë¶„ëŸ‰ ì¡°ì ˆ.
---ìƒí’ˆ1---
(ìš”ì•½)
---ìƒí’ˆ2---
(ìš”ì•½)
...

[ìƒí’ˆ ëª©ë¡]
{items_text}
""",
        "ê¸°íƒ€": f"""ë‹¹ì‹ ì€ ë„¤ì´ë²„ ì¹´í˜ ë¸”ë¡œê·¸ ì „ë¬¸ ë¦¬ë·°ì–´ì…ë‹ˆë‹¤.
ë°œí–‰ ì¹´í…Œê³ ë¦¬: ê¸°íƒ€
ê²€ìƒ‰ í‚¤ì›Œë“œ "{keyword}"ì— ëŒ€í•´ ì‘ì„±í•´ì£¼ì„¸ìš”.
{base_rules}

[íŒŒíŠ¸ A: ì œí’ˆ ì†Œê°œ ë„ì…]
- "{keyword}"ì— ëŒ€í•´ ì¼ë°˜ì ì¸ ì†Œê°œë¥¼ í•˜ì„¸ìš”.
---ë„ì…ë¶€---
(ë„ì…ë¶€ ë¬¸êµ¬)

[íŒŒíŠ¸ B: ìƒí’ˆë³„ ìš”ì•½ - ê¸°íƒ€ í˜•ì‹]
ê° ìƒí’ˆë§ˆë‹¤: íŠ¹ì§• 3ê°€ì§€, í™œìš© ë°©ë²•. length_modeì— ë§ê²Œ ë¶„ëŸ‰ ì¡°ì ˆ.
---ìƒí’ˆ1---
(ìš”ì•½)
---ìƒí’ˆ2---
(ìš”ì•½)
...

[ìƒí’ˆ ëª©ë¡]
{items_text}
""",
    }
    return prompts.get(category, prompts["ê¸°íƒ€"])


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì œëª© í…œí”Œë¦¿ (í¬ìŠ¤íŒ…ë§ˆë‹¤ ëœë¤ ì„ íƒ)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TITLE_TEMPLATES = [
    "[ì¶”ì²œ] ìš”ì¦˜ ë‚œë¦¬ ë‚œ {keyword} ì§ì ‘ ì¨ë³´ë‹ˆ ë‹¤ë¥´ë„¤ìš”!",
    "{keyword} ê°€ì„±ë¹„ ì‹¤í™”? ì†”ì§ ë¦¬ë·° ê³µìœ í•©ë‹ˆë‹¤",
    "í’ˆì ˆì£¼ì˜! {keyword} ë¹„êµ ë¶„ì„í•´ë´¤ì–´ìš”",
    "ğŸ”¥ {keyword} ë² ìŠ¤íŠ¸ ì¶”ì²œ TOP{count} ì´ì •ë¦¬",
    "{keyword} ê³ ë¯¼ì´ë¼ë©´ ì´ ê¸€ í•˜ë‚˜ë¡œ í•´ê²°!",
    "ìš”ì¦˜ í•«í•œ {keyword}, ì•ˆ ì‚¬ë©´ í›„íšŒí• ê±¸ìš”?",
    "âœ¨ {keyword} ì–´ë–¤ ê²Œ ì¢‹ì„ê¹Œ? ê¼¼ê¼¼ ë¹„êµ ë¦¬ë·°",
    "{keyword} ì¶”ì²œ ë¦¬ìŠ¤íŠ¸ | ì§„ì§œ ì¨ë³¸ ì‚¬ëŒì˜ í›„ê¸°",
    "ê°€ì„±ë¹„ ê°‘! {keyword} ì´ê±´ ê¼­ ì•Œì•„ì•¼ í•´ìš”",
    "ì§ì ‘ ë¹„êµí•´ë´¤ìŠµë‹ˆë‹¤ - {keyword} ìµœì¢… ì¶”ì²œ ğŸ†",
]


def _pick_random_title(keyword, product_count):
    """ì œëª© í…œí”Œë¦¿ì—ì„œ ëœë¤ ì„ íƒ í›„ í‚¤ì›Œë“œì™€ ìƒí’ˆ ìˆ˜ë¥¼ ì±„ìš´ë‹¤."""
    template = random.choice(TITLE_TEMPLATES)
    return template.format(keyword=keyword, count=product_count)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# í†µí•© Gemini í˜¸ì¶œ: ë„ì…ë¶€ + ìƒí’ˆë³„ ìš”ì•½ (ì¹´í…Œê³ ë¦¬ë³„ í”„ë¡¬í”„íŠ¸)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def generate_intro_and_summaries(products, keyword, category="ê±´ê°•ì‹í’ˆ", length_mode="medium", gemini_api_key=None):
    """
    í•œ ë²ˆì˜ Gemini API í˜¸ì¶œë¡œ:
      1) ì¹´í…Œê³ ë¦¬ì— ë§ëŠ” ë„ì…ë¶€
      2) ê° ìƒí’ˆë³„ ìš”ì•½ (ì¹´í…Œê³ ë¦¬ë³„ êµ¬ì¡°)
    ë¥¼ ë™ì‹œì— ë°›ì•„ì˜¨ë‹¤.

    Returns:
        (intro_text, {index: summary_text}) íŠœí”Œ
    """
    gemini_api_key = gemini_api_key or GEMINI_API_KEY

    # ìƒí’ˆ ëª©ë¡ í…ìŠ¤íŠ¸ êµ¬ì„±
    items_text = ""
    for i, p in enumerate(products, 1):
        name = p.get("productName", "")
        prod_cat = p.get("categoryName", "ì¼ë°˜")
        price_str = (
            f"{p['productPrice']:,}ì›"
            if isinstance(p.get("productPrice"), (int, float))
            else str(p.get("productPrice", ""))
        )
        rocket = " [ë¡œì¼“ë°°ì†¡]" if p.get("isRocket") else ""
        free_ship = " [ë¬´ë£Œë°°ì†¡]" if p.get("isFreeShipping") else ""

        items_text += (
            f"[ìƒí’ˆ {i}]\n"
            f"  ìƒí’ˆëª…: {name}\n"
            f"  ì¹´í…Œê³ ë¦¬: {prod_cat}\n"
            f"  ê°€ê²©: {price_str}{rocket}{free_ship}\n\n"
        )

    prompt = _get_category_prompt(category, keyword, items_text, length_mode)

    url = f"{GEMINI_API_URL}?key={gemini_api_key}"
    payload = {
        "contents": [{"parts": [{"text": prompt}]}],
        "generationConfig": {
            "temperature": 0.85,
            "maxOutputTokens": 3000,
        },
    }
    headers = {"Content-Type": "application/json"}

    try:
        response = requests.post(
            url, headers=headers, json=payload, timeout=45,
            proxies={"http": None, "https": None},
        )
        response.raise_for_status()

        result = response.json()
        text = (
            result
            .get("candidates", [{}])[0]
            .get("content", {})
            .get("parts", [{}])[0]
            .get("text", "")
        )

        if not text:
            print("[ê²½ê³ ] Gemini ì‘ë‹µì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.")
            return _fallback_intro(keyword), _fallback_summaries(products)

        # íŒŒì‹±
        intro = _parse_intro(text, keyword)
        summaries = _parse_summaries(text, len(products))

        print(f"[ì™„ë£Œ] Gemini í†µí•© ìƒì„± ì™„ë£Œ [{category}/{length_mode}] â€” ë„ì…ë¶€: {len(intro)}ì, "
              f"ìš”ì•½: {len(summaries)}ê°œ")
        return intro, summaries

    except requests.RequestException as e:
        print(f"[ì˜¤ë¥˜] Gemini API í˜¸ì¶œ ì‹¤íŒ¨: {e}")
        return _fallback_intro(keyword), _fallback_summaries(products)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# íŒŒì‹± í•¨ìˆ˜ë“¤
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def _parse_intro(text, keyword):
    """Gemini ì‘ë‹µì—ì„œ ---ë„ì…ë¶€--- ì„¹ì…˜ì„ ì¶”ì¶œí•œë‹¤."""
    match = re.search(r'---\s*ë„ì…ë¶€\s*---\s*\n(.*?)(?=---\s*ìƒí’ˆ\s*\d|$)', text, re.DOTALL)
    if match:
        intro = match.group(1).strip()
        if intro:
            return intro
    return _fallback_intro(keyword)


def _parse_summaries(text, count):
    """Gemini ì‘ë‹µì—ì„œ ---ìƒí’ˆN--- êµ¬ë¶„ìë¡œ ë¶„ë¦¬í•˜ì—¬ ìš”ì•½ì„ ì¶”ì¶œí•œë‹¤."""
    summaries = {}
    parts = re.split(r'---\s*ìƒí’ˆ\s*(\d+)\s*---', text)

    for i in range(1, len(parts) - 1, 2):
        try:
            idx = int(parts[i]) - 1
            summary = parts[i + 1].strip()
            # ë‹¤ìŒ ì„¹ì…˜ ì‹œì‘ ì „ê¹Œì§€ë§Œ (í˜¹ì‹œ ë‚¨ì€ í…ìŠ¤íŠ¸ ì œê±°)
            summary = re.split(r'---\s*(?:ìƒí’ˆ|ë„ì…ë¶€)\s*', summary)[0].strip()
            if summary:
                summaries[idx] = summary
        except (ValueError, IndexError):
            continue

    if not summaries and text.strip():
        summaries[0] = text.strip()

    return summaries


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Fallback í•¨ìˆ˜ë“¤ (Gemini ì‹¤íŒ¨ ì‹œ)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def _fallback_intro(keyword):
    intros = [
        f"ìš”ì¦˜ {keyword} ë•Œë¬¸ì— ê³ ë¯¼ì´ ë§ìœ¼ì‹œì£ ? ğŸ˜Š ì¢…ë¥˜ë„ ë„ˆë¬´ ë§ê³ , ê°€ê²©ë„ ì²œì°¨ë§Œë³„ì´ë¼ "
        f"ë­˜ ê³¨ë¼ì•¼ í• ì§€ ë§‰ë§‰í•˜ë”ë¼ê³ ìš”. ì €ë„ í•œì°¸ ë¹„êµí•˜ë‹¤ê°€ ê²°êµ­ ì§ì ‘ ì •ë¦¬í•´ë´¤ì–´ìš”! "
        f"ì˜¤ëŠ˜ ì œê°€ ê¼¼ê¼¼í•˜ê²Œ ë¹„êµí•´ë³¸ ê²°ê³¼ë¥¼ ê³µìœ í•´ë“œë¦´ê²Œìš” âœ¨",
        f"{keyword} ì¶”ì²œ ì œí’ˆì„ ì°¾ê³  ê³„ì‹ ê°€ìš”? ì €ë„ ì–¼ë§ˆ ì „ ê°™ì€ ê³ ë¯¼ì„ í–ˆì—ˆëŠ”ë°ìš”, "
        f"ì´ê²ƒì €ê²ƒ ì•Œì•„ë³´ë©´ì„œ ì •ë§ ê´œì°®ì€ ì œí’ˆë“¤ì„ ë°œê²¬í–ˆì–´ìš”! "
        f"ì‹œê°„ ì ˆì•½í•˜ì‹¤ ìˆ˜ ìˆë„ë¡ í•µì‹¬ë§Œ ì •ë¦¬í•´ë´¤ìœ¼ë‹ˆ ëê¹Œì§€ ì½ì–´ì£¼ì„¸ìš” ğŸ’•",
    ]
    return random.choice(intros)


def _fallback_summaries(products):
    summaries = {}
    for i, p in enumerate(products):
        name = p.get("productName", "ìƒí’ˆ")
        category = p.get("categoryName", "")
        tags = []
        if p.get("isRocket"):
            tags.append("ë¡œì¼“ë°°ì†¡ ì§€ì›")
        if p.get("isFreeShipping"):
            tags.append("ë¬´ë£Œë°°ì†¡")
        tag_str = ", ".join(tags) if tags else "í•©ë¦¬ì ì¸ ê°€ê²©"

        summaries[i] = (
            f"âœ¨ {name[:20]}... ì œí’ˆì„ ë¶„ì„í•´ë´¤ì–´ìš”! "
            f"{category} ì¹´í…Œê³ ë¦¬ì—ì„œ ì¸ê¸° ìˆëŠ” ì´ìœ ê°€ ìˆë”ë¼ê³ ìš”. "
            f"{tag_str}ê¹Œì§€ ì§€ì›í•´ì„œ ê°€ì„±ë¹„ê°€ ì •ë§ ì¢‹ì•„ìš”. "
            f"ê¼¼ê¼¼í•˜ê²Œ ë¹„êµí•´ë³´ì‹œëŠ” ë¶„ë“¤ê»˜ ì¶”ì²œë“œë ¤ìš”! ğŸ˜Š"
        )
    return summaries


def _random_closing(keyword):
    """í‚¤ì›Œë“œë¥¼ í¬í•¨í•œ ìì—°ìŠ¤ëŸ¬ìš´ ë§ˆë¬´ë¦¬ ë¬¸êµ¬ë¥¼ ëœë¤ ìƒì„±"""
    templates = [
        f"{keyword} êµ¬ë§¤ ì •ë³´ëŠ” ëŒ“ê¸€ì— í•¨ê»˜ ë‚¨ê²¨ë†“ì„ê²Œìš”~",
        f"ë„ì›€ì´ ë˜ì…¨ë‹¤ë©´ ì¢‹ì•„ìš” ëˆŒëŸ¬ì£¼ì„¸ìš” :) {keyword} êµ¬ë§¤ì²˜ëŠ” ëŒ“ê¸€ ì°¸ê³ í•´ì£¼ì„¸ìš”!",
        f"í•„ìš”í•˜ì‹  ë¶„ë“¤ì„ ìœ„í•´ {keyword} êµ¬ë§¤ ë§í¬ëŠ” ëŒ“ê¸€ì— ì •ë¦¬í•´ë‘ì—ˆì–´ìš”~",
        f"{keyword} ê´€ë ¨ êµ¬ë§¤ ì •ë³´ê°€ ê¶ê¸ˆí•˜ì‹œë©´ ëŒ“ê¸€ í™•ì¸í•´ì£¼ì„¸ìš” ğŸ˜Š",
        f"{keyword} êµ¬ë§¤ì²˜ëŠ” ëŒ“ê¸€ì— ì˜¬ë ¤ë†“ì•˜ìœ¼ë‹ˆ ì°¸ê³ í•˜ì„¸ìš”~",
        f"í˜¹ì‹œ {keyword} êµ¬ë§¤ê°€ í•„ìš”í•˜ì‹œë©´ ëŒ“ê¸€ì— ë§í¬ ë‚¨ê²¨ë‘ì—ˆì–´ìš”!",
        f"{keyword} êµ¬ë§¤ ë§í¬ ëŒ“ê¸€ì— ì •ë¦¬í•´ë†“ì•˜ìœ¼ë‹ˆ í¸í•˜ê²Œ í™•ì¸í•˜ì„¸ìš”~",
        f"ì°¸ê³ ê°€ ë˜ì…¨ìœ¼ë©´ ì¢‹ê² ì–´ìš”! {keyword} êµ¬ë§¤ì²˜ëŠ” ëŒ“ê¸€ì— ìˆì–´ìš” :)",
        f"ê¶ê¸ˆí•˜ì‹  ë¶„ë“¤ì€ ëŒ“ê¸€ í™•ì¸í•´ì£¼ì„¸ìš”~ {keyword} ì •ë³´ ì •ë¦¬í•´ë‘ì—ˆìŠµë‹ˆë‹¤!",
        f"{keyword} ì§ì ‘ ë³´ê³  ì‹¶ìœ¼ì‹  ë¶„ë“¤ì€ ëŒ“ê¸€ì— ë§í¬ ë‚¨ê²¨ë†“ì•˜ì–´ìš”~",
    ]
    return random.choice(templates)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ê°€ë…ì„± ìŠ¤íƒ€ì¼: ê°€ê²©Â·í˜œíƒ ê°•ì¡° ë§ˆì»¤
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def _apply_highlight_markers(body):
    """
    ê°€ê²© ë“± í•µì‹¬ ì •ë³´ì— [C]...[/C] ë§ˆì»¤ë¥¼ ì ìš©.
    write_cafe_postì—ì„œ íŒŒë€ìƒ‰(#0000FF)ìœ¼ë¡œ ë Œë”ë§.
    """
    # ê°€ê²© íŒ¨í„´: 12,000ì›, 1,234,567ì›
    body = re.sub(r'(\d{1,3}(?:,\d{3})*ì›)', r'[C]\1[/C]', body)
    return body


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# í‚¤ì›Œë“œ ëœë¤ ë°˜ë³µ ì‚½ì…
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def _insert_keyword_naturally(body, keyword, repeat_min=3, repeat_max=7):
    """
    ë³¸ë¬¸ ì¤‘ê°„ì¤‘ê°„ ìì—°ìŠ¤ëŸ¬ìš´ ìœ„ì¹˜ì— í‚¤ì›Œë“œë¥¼ ëœë¤ íšŸìˆ˜ë§Œí¼ ì‚½ì…í•œë‹¤.
    - ë¹ˆ ì¤„ ì§í›„ì˜ í…ìŠ¤íŠ¸ ì¤„ì— í‚¤ì›Œë“œë¥¼ ì•Â·ë’¤ì— ìì—°ìŠ¤ëŸ½ê²Œ ë¶™ì¸ë‹¤.
    - ì´ë¯¸ í‚¤ì›Œë“œê°€ ìˆëŠ” ì¤„ì€ ê±´ë„ˆë›´ë‹¤.
    """
    if repeat_min <= 0 and repeat_max <= 0:
        return body

    target_count = random.randint(max(1, repeat_min), max(1, repeat_max))

    # í‚¤ì›Œë“œë¥¼ ì‚½ì…í•  ìˆ˜ ìˆëŠ” ìì—°ìŠ¤ëŸ¬ìš´ ë¬¸êµ¬ë“¤
    keyword_phrases = [
        f"{keyword} ê´€ë ¨í•´ì„œ ë§ì”€ë“œë¦¬ë©´,",
        f"íŠ¹íˆ {keyword}ì„(ë¥¼) ì°¾ëŠ” ë¶„ë“¤ì€",
        f"{keyword} ì„ íƒ ì‹œ ì°¸ê³ í•˜ì„¸ìš”!",
        f"ì—­ì‹œ {keyword}ì€(ëŠ”)",
        f"{keyword} ë¹„êµ í¬ì¸íŠ¸ë¡œ ë³´ë©´,",
        f"ì¸ê¸° {keyword} ì¤‘ì—ì„œë„",
        f"{keyword} ê³ ë¯¼ì´ë¼ë©´ ì°¸ê³ í•˜ì„¸ìš” ğŸ‘‰",
    ]

    lines = body.split("\n")
    # ì‚½ì… ê°€ëŠ¥í•œ ìœ„ì¹˜ ì°¾ê¸°: í…ìŠ¤íŠ¸ê°€ ìˆëŠ” ì¤„ ì¤‘ í‚¤ì›Œë“œê°€ ì—†ê³ , ë§ˆì»¤/êµ¬ë¶„ì„ ì´ ì•„ë‹Œ ì¤„
    insertable_indices = []
    for idx, line in enumerate(lines):
        stripped = line.strip()
        if (
            stripped
            and keyword not in stripped
            and not stripped.startswith(("â”", "â”€", "â•", "â–¶", "ğŸ“¸", "ğŸ’°", "ğŸ›’", "â€»", "[", "âœ…"))
            and "go.kdgc.co.kr" not in stripped
            and len(stripped) > 10  # ë„ˆë¬´ ì§§ì€ ì¤„ ì œì™¸
        ):
            insertable_indices.append(idx)

    # ì‚½ì…í•  ìœ„ì¹˜ ëœë¤ ì„ íƒ
    actual_count = min(target_count, len(insertable_indices))
    if actual_count <= 0:
        return body

    chosen = sorted(random.sample(insertable_indices, actual_count))

    for idx in reversed(chosen):  # ë’¤ì—ì„œë¶€í„° ì‚½ì… (ì¸ë±ìŠ¤ ë°€ë¦¼ ë°©ì§€)
        phrase = random.choice(keyword_phrases)
        lines.insert(idx, phrase)

    return "\n".join(lines)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ìµœì¢… ë„¤ì´ë²„ ì¹´í˜ ê²Œì‹œê¸€ ì¡°ë¦½
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def assemble_final_post(products, keyword, intro, summaries,
                        image_paths=None,
                        keyword_repeat_min=3, keyword_repeat_max=7,
                        use_product_name=False):
    """
    ê³µê° ë„ì…ë¶€ + Gemini ìš”ì•½ + ìƒí’ˆ ì´ë¯¸ì§€ë¥¼ ì¡°í•©í•˜ì—¬
    ë„¤ì´ë²„ ì¹´í˜ìš© ì™„ì„± ê²Œì‹œê¸€ì„ ë§Œë“ ë‹¤.

    ê²Œì‹œê¸€ êµ¬ì¡°:
      ì œëª©: ëœë¤ í…œí”Œë¦¿ ì„ íƒ
      ë³¸ë¬¸:
        - ê³µê° ë„ì…ë¶€ (Gemini)
        - ìƒí’ˆë³„ ì„¹ì…˜ (ìš”ì•½ + ì´ë¯¸ì§€)
        - í‚¤ì›Œë“œ ìì—°ìŠ¤ëŸ¬ìš´ ë°˜ë³µ ì‚½ì…
        - ë§ˆë¬´ë¦¬ ë¬¸êµ¬ (í‚¤ì›Œë“œ í¬í•¨, ëœë¤)
    """
    # â”€â”€ ì œëª© (ëœë¤ í…œí”Œë¦¿) â”€â”€
    # use_product_name: ê²€ìƒ‰ í‚¤ì›Œë“œ ëŒ€ì‹  ìƒí’ˆëª…ìœ¼ë¡œ ì œëª© ìƒì„±
    title_keyword = keyword
    if use_product_name and products:
        names = [p.get("productName", "").strip() for p in products if p.get("productName", "").strip()]
        if names:
            title_keyword = random.choice(names)
    title = _pick_random_title(title_keyword, len(products))

    # â”€â”€ ë³¸ë¬¸ êµ¬ì„± â”€â”€
    # êµ¬ì¡°: ì²« ë¬¸ë‹¨(ë„ì…) â†’ ëŒ€í‘œ ì´ë¯¸ì§€ 1ì¥ â†’ ì¤„ë°”ê¿ˆ 2ì¤„ ì´ìƒ â†’ ì œí’ˆì •ë³´
    body = ""

    # 1) ê³µê° ë„ì…ë¶€ (ì²« ë²ˆì§¸ ë¬¸ë‹¨)
    if intro:
        body += f"{intro}\n\n"

    # 2) ëŒ€í‘œ ì´ë¯¸ì§€ 1ì¥ - ì²« ë¬¸ë‹¨ ë°”ë¡œ ì•„ë˜ ê³ ì •
    first_name = products[0].get("productName", "") if products else ""
    if image_paths and first_name and first_name in image_paths:
        body += "ğŸ“¸ [ìƒí’ˆ ì´ë¯¸ì§€]\n\n\n\n"  # ì´ë¯¸ì§€ ë’¤ ì¤„ë°”ê¿ˆ 2ì¤„ ì´ìƒ

    # 3) ìƒí’ˆë³„ ì„¹ì…˜ (ì œí’ˆì •ë³´ë§Œ, ì´ë¯¸ì§€ ì—†ìŒ)
    for i, p in enumerate(products):
        name = p.get("productName", "")

        if i > 0:
            body += "\n\n"

        body += f"âœ… ì˜¤ëŠ˜ì˜ ì¶”ì²œ ìƒí’ˆ: {name}\n\n"

        summary = summaries.get(i, "")
        if summary:
            body += f"{summary}\n\n"

    # 3) í‚¤ì›Œë“œ ìì—°ìŠ¤ëŸ¬ìš´ ë°˜ë³µ ì‚½ì…
    body = _insert_keyword_naturally(
        body, keyword,
        repeat_min=keyword_repeat_min,
        repeat_max=keyword_repeat_max,
    )

    # 4) ë§ˆë¬´ë¦¬
    body += "\n\n"
    body += f"{_random_closing(keyword)}\n"

    # * ë¬¸ì ì œê±° (ë§ˆí¬ë‹¤ìš´ ì„œì‹ ì”ì—¬ë¬¼)
    body = body.replace("**", "").replace("*", "")

    # 5) ê°€ë…ì„±: ê°€ê²©Â·í˜œíƒ ê°•ì¡° ë§ˆì»¤ [C]...[/C] ì ìš©
    body = _apply_highlight_markers(body)

    full_post = f"[ì œëª©]\n{title}\n\n[ë³¸ë¬¸]\n{body}"
    return full_post


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì¹´í…Œê³ ë¦¬ë³„ ê¸€ ìƒì„± (ë¶„ê¸°)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def _generate_post_with_category(products, keyword, category, length_mode, **kwargs):
    """ì¹´í…Œê³ ë¦¬Â·length_mode ì§€ì •í•˜ì—¬ ë„ì…ë¶€+ìš”ì•½ ìƒì„± í›„ ì¡°ë¦½"""
    intro, summaries = generate_intro_and_summaries(
        products, keyword, category=category,
        length_mode=length_mode,
        gemini_api_key=kwargs.get("gemini_api_key"),
    )
    return assemble_final_post(
        products, keyword, intro, summaries,
        image_paths=kwargs.get("image_paths"),
        keyword_repeat_min=kwargs.get("keyword_repeat_min", 3),
        keyword_repeat_max=kwargs.get("keyword_repeat_max", 7),
        use_product_name=kwargs.get("use_product_name", False),
    )


def generate_health_post(products, keyword, length_mode, **kwargs):
    """ê±´ê°•ì‹í’ˆ ì¹´í…Œê³ ë¦¬: ê³µê°í˜• ë„ì…, ì„±ë¶„/íŠ¹ì§•, ì¶”ì²œëŒ€ìƒ, ê°€ê²©ëŒ€"""
    return _generate_post_with_category(products, keyword, "ê±´ê°•ì‹í’ˆ", length_mode, **kwargs)


def generate_living_post(products, keyword, length_mode, **kwargs):
    """ìƒí™œìš©í’ˆ ì¹´í…Œê³ ë¦¬: ë¶ˆí¸ ìƒí™©, ë°œê²¬ê³„ê¸°, ì‚¬ìš©ê°, ì¥ì 3ê°€ì§€, ê°€ê²©"""
    return _generate_post_with_category(products, keyword, "ìƒí™œìš©í’ˆ", length_mode, **kwargs)


def generate_electronics_post(products, keyword, length_mode, **kwargs):
    """ê°€ì „ì œí’ˆ ì¹´í…Œê³ ë¦¬: ê¸°ì¡´ ì œí’ˆ ë¹„êµ, ìŠ¤í™, ì¥ë‹¨ì , ì¶”ì²œëŒ€ìƒ, ê°€ê²©ëŒ€"""
    return _generate_post_with_category(products, keyword, "ê°€ì „ì œí’ˆ", length_mode, **kwargs)


def generate_baby_post(products, keyword, length_mode, **kwargs):
    """ìœ ì•„/ì¶œì‚° ì¹´í…Œê³ ë¦¬: ì•ˆì „ì„± ë„ì…, ì†Œì¬/ì„±ë¶„, ë¶€ëª¨ í›„ê¸° ëŠë‚Œ"""
    return _generate_post_with_category(products, keyword, "ìœ ì•„/ì¶œì‚°", length_mode, **kwargs)


def generate_etc_post(products, keyword, length_mode, **kwargs):
    """ê¸°íƒ€ ì¹´í…Œê³ ë¦¬: ì œí’ˆ ì†Œê°œ, íŠ¹ì§• 3ê°€ì§€, í™œìš© ë°©ë²•"""
    return _generate_post_with_category(products, keyword, "ê¸°íƒ€", length_mode, **kwargs)


def generate_post(products, keyword, category, length_mode, **kwargs):
    """
    ì¹´í…Œê³ ë¦¬Â·length_mode ê¸°ë°˜ìœ¼ë¡œ í•´ë‹¹ ì „ìš© ìƒì„± í•¨ìˆ˜ë¡œ ë¶„ê¸°.

    Args:
        products: ìƒí’ˆ ë¦¬ìŠ¤íŠ¸
        keyword: ê²€ìƒ‰ í‚¤ì›Œë“œ
        category: ë°œí–‰ ì¹´í…Œê³ ë¦¬
        length_mode: short | medium

    Returns:
        ì™„ì„±ëœ ê²Œì‹œê¸€ ë¬¸ìì—´
    """
    if category == "ê±´ê°•ì‹í’ˆ":
        return generate_health_post(products, keyword, length_mode, **kwargs)
    elif category == "ìƒí™œìš©í’ˆ":
        return generate_living_post(products, keyword, length_mode, **kwargs)
    elif category == "ê°€ì „ì œí’ˆ":
        return generate_electronics_post(products, keyword, length_mode, **kwargs)
    elif category == "ìœ ì•„/ì¶œì‚°":
        return generate_baby_post(products, keyword, length_mode, **kwargs)
    else:
        return generate_etc_post(products, keyword, length_mode, **kwargs)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ë©”ì¸ ì§„ì…ì : generate_promo_post (ê¸°ì¡´ ì¸í„°í˜ì´ìŠ¤ ìœ ì§€ + í™•ì¥)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def generate_promo_post(products, keyword, gemini_api_key=None, image_paths=None,
                        keyword_repeat_min=3, keyword_repeat_max=7,
                        use_product_name=False, category="ê±´ê°•ì‹í’ˆ"):
    """
    ì „ì²´ ê²Œì‹œê¸€ ìƒì„± íŒŒì´í”„ë¼ì¸.
    categoryì— ë”°ë¼ ì¹´í…Œê³ ë¦¬ë³„ í…œí”Œë¦¿ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.

    Args:
        products: ìƒí’ˆ ì •ë³´ ë”•ì…”ë„ˆë¦¬ ë¦¬ìŠ¤íŠ¸
        keyword: ê²€ìƒ‰ í‚¤ì›Œë“œ
        gemini_api_key: Gemini API í‚¤
        image_paths: ì´ë¯¸ì§€ ê²½ë¡œ ë”•ì…”ë„ˆë¦¬ (ì„ íƒ)
        keyword_repeat_min: í‚¤ì›Œë“œ ë°˜ë³µ ìµœì†Œ íšŸìˆ˜
        keyword_repeat_max: í‚¤ì›Œë“œ ë°˜ë³µ ìµœëŒ€ íšŸìˆ˜
        use_product_name: ì œëª©ì— ìƒí’ˆëª… ì‚¬ìš© ì—¬ë¶€
        category: ë°œí–‰ ì¹´í…Œê³ ë¦¬ (ê±´ê°•ì‹í’ˆ/ìƒí™œìš©í’ˆ/ê°€ì „ì œí’ˆ/ìœ ì•„ì¶œì‚°/ê¸°íƒ€)

    Returns:
        ì™„ì„±ëœ ê²Œì‹œê¸€ ë¬¸ìì—´
    """
    length_mode = random.choice(LENGTH_MODES)
    print(f"\n[Gemini] í†µí•© ìƒì„± ì¤‘ (ì¹´í…Œê³ ë¦¬: {category}, ë¶„ëŸ‰: {length_mode})...")
    post = generate_post(
        products, keyword, category, length_mode,
        gemini_api_key=gemini_api_key,
        image_paths=image_paths,
        keyword_repeat_min=keyword_repeat_min,
        keyword_repeat_max=keyword_repeat_max,
        use_product_name=use_product_name,
    )
    print(f"[ì™„ë£Œ] ë„¤ì´ë²„ ì¹´í˜ ê²Œì‹œê¸€ ìƒì„± ì™„ë£Œ [{category}/{length_mode}]")
    return post
